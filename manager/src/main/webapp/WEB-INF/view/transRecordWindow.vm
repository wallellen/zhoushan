<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />  
	<style >
		.location-active {
			background-color: green !important;
		}
		.mapclass{
			width:;
			height:600px;
			overflow:hidden;
		}
    </style>
	<link href="$!request.getContextPath()/public/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
	<link href="$!request.getContextPath()/public/css/metro.css" rel="stylesheet" />
	<link href="$!request.getContextPath()/public/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet" />
	<link href="$!request.getContextPath()/public/css/style.css" rel="stylesheet" />
	<link href="$!request.getContextPath()/public/css/style_responsive.css" rel="stylesheet" />
	<link href="$!request.getContextPath()/public/css/style_light.css" rel="stylesheet" id="style_color" />
	<link rel="shortcut icon" href="favicon.ico" />
	<link href="$!request.getContextPath()/public/font-awesome/css/font-awesome.css" rel="stylesheet">
</head>

<body style="width:50%;">
	<div class="portlet box green">
      <div class="portlet-title">
         <h4><i class="icon-reorder"></i>运输详情</h4>
      </div>
      <div class="portlet-body form">
         <!-- BEGIN FORM-->
         <form action="#" class="form-horizontal">
            <h3 class="form-section">车辆信息</h3>
            <div class="row-fluid">
               <div class="span6 ">
                  <div class="control-group">
                     <label class="control-label">驾驶员</label>
                     <div class="controls">
                        <input type="text" class="m-wrap span12" id="trans_driver1" disabled="disabled" value = "123">
                     </div>
                  </div>
               </div>
               <!--/span-->
               <div class="span6 ">
                  <div class="control-group">
                     <label class="control-label">车辆或船只牌照</label>
                     <div class="controls">
                        <input type="text" class="m-wrap span12" id="trans_license1" disabled="disabled">
                     </div>
                  </div>
               </div>
               <!--/span-->
            </div>
            <!--/row-->
            <div class="row-fluid">
               <div class="span6 ">
                  <div class="control-group">
                     <label class="control-label">出发地点</label>
                     <div class="controls">
                        <input type="text" class="m-wrap span12" id="trans_start_place1" disabled="disabled">
                     </div>
                  </div>
               </div>
               <!--/span-->
               <div class="span6 ">
                  <div class="control-group">
                     <label class="control-label">到达地点</label>
                     <div class="controls">
                        <input type="text" class="m-wrap span12" id="trans_end_place1" disabled="disabled">
                     </div>
                  </div>
               </div>
               <!--/span-->
            </div>

            <div class="row-fluid">
               <div class="span6 ">
                  <div class="control-group">
                     <label class="control-label">出发时间</label>
                     <div class="controls">
                        <input type="text" class="m-wrap span12" id="trans_start_time1" disabled="disabled">
                     </div>
                  </div>
               </div>
               <!--/span-->
               <div class="span6 ">
                  <div class="control-group">
                     <label class="control-label">到达时间</label>
                     <div class="controls">
                        <input type="text" class="m-wrap span12" id="trans_end_time1" disabled="disabled">
                     </div>
                  </div>
               </div>
               <!--/span-->
            </div>

            <h3 class="form-section">路径信息</h3>
            <div class="row-fluid">
			   <button type="button" class="btn red editBt" onClick="timedCount()">实时跟踪</button>
			   <button type="button" class="btn red editBt" onClick="stopCount()">停止跟踪</button>
               <div id="mapContainer" class="mapclass">
			   <!--显示地图-->
               </div>
            </div>          
            <!--/row-->

            <h3 class="form-section">温度统计</h3>
            <div class="row-fluid">
               <div class="span12">
                     暂无信息
                  </div>
            </div>          
            <!--/row-->

         </form>
         <!-- END FORM-->                
      </div>
   </div>
</body>
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=cFd5LkakiVL0fxGypWqsLZFg"></script>				
<script type="text/javascript">
var map = new BMap.Map("mapContainer");
map.centerAndZoom(new BMap.Point(106.52097,29.531878),17);
map.enableScrollWheelZoom();
var oldPoint = new BMap.Point(106.52097,29.53187);
var transDatas;
var t;
var c=1;
function show(){
	var sContent =
	"<h4 style='margin:0 0 5px 0;padding:0.2em 0'>"+transDatas.gid+"号车辆</h4>" + 
	"<p style='margin:0;line-height:1.5;font-size:13px;'>"+
	"坐标：("+transDatas.longitude+","+transDatas.latitude+")" + 
	"<br/>时刻："+transDatas.time+ 
	"<br/>温度："+transDatas.temperature+
	"</p>";
	var newPoint = new BMap.Point(transDatas.longitude, transDatas.latitude);
	var marker = new BMap.Marker(newPoint);
	var infoWindow = new BMap.InfoWindow(sContent);  // 创建信息窗口对象
	map.addOverlay(marker);
	marker.addEventListener("click", function(){          
		this.openInfoWindow(infoWindow);
	});
	//绘制折线
	var polyline = new BMap.Polyline([
		oldPoint,
		newPoint
	], {strokeColor:"blue", strokeWeight:6, strokeOpacity:0.5});
	map.addOverlay(polyline);
	oldPoint = newPoint;
}
function timedCount()
{
	$ .ajax({
		type: "POST",
		url: '$!request.getContextPath()/Traceability/receiveData',
		data: { "lineno": c },
		success: function (data) {
			//需要两次JSON解析
			transDatas = JSON.parse(data);
			transDatas = JSON.parse(transDatas);
			if(null==transDatas){
				clearTimeout(t);
				return;
			}
			//var obj=eval ("(" + transDatas + ")");
			//alert(transDatas.id);
			show();
		}
	});
	c=c+10
	t=setTimeout("timedCount()",1000)
}
function stopCount(){
	clearTimeout(t)
}
function handleTransRecord(tr){
   jQuery("#trans_license1").val(tr.license);
   jQuery("#trans_driver1").val(tr.driver);
   jQuery("#trans_end_time1").val(tr.endTime);
   jQuery("#trans_start_time1").val(tr.startTime);
   jQuery("#trans_end_place1").val(tr.endPlace);
   jQuery("#trans_start_place1").val(tr.startPlace);
}

jQuery(function(jQuery) {
   var tr = eval($!{transInfo});
   handleTransRecord(tr);
});
</script>
</html>